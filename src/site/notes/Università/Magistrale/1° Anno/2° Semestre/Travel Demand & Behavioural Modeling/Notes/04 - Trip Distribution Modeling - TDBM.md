---
{"dg-publish":true,"permalink":"/universita/magistrale/1-anno/2-semestre/travel-demand-and-behavioural-modeling/notes/04-trip-distribution-modeling-tdbm/","tags":["UNI"]}
---

# [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM\|04 - Trip Distribution Modeling - TDBM]]

```table-of-contents
```


**Trip Distribution** is the second step in the [[00 - Intro to subject - TDBM#2 - Modeling|modeling]] stage of the [[00 - Intro to subject - TDBM#Classic 4 stage framework|classic 4 stage framework]].

In terms of an O/D matrix like the following, in this step we try to model each and every $d_{ij}$:
$$
\begin{matrix}
d_{11} & d_{12}  & \cdots & d_{1n} & \boldsymbol{P_{1}} \\
d_{21} & d_{22}  & \cdots & d_{2n} & \boldsymbol{P_{2}} \\
\vdots & \vdots  & d_{ij} & \vdots & \vdots\\
d_{n1} & d_{n2}  & \cdots & d_{nn} & \boldsymbol{P_{n}} \\
\boldsymbol{A_{1}} & \boldsymbol{A_{2}} & \cdots & \boldsymbol{A_{n}}
\end{matrix}
$$
where:
- $d_{ij}:$ number of trips from TAZ $i$ to TAZ $j$
- $P_{i}:$ tot number of trips generated by TAZ $i$
	- It's the sum of the colums
- $A_{i}:$ tot number of trips attracted by TAZ $j$
	- It's the sum of the rows
- $n:$ tot number of TAZs

```ad-attention
Along this note, the number of trips from TAZ $i$ to TAZ $j$ will sometime be indicated with the symbol $t_{ij}$

```

## Introduction

Trip distribution models are conceptually simple but give a hard time when we try to integrate them with the other models in the 4 stage process (for example, often, the sum of the number of trips from one zone does not add app to the modelled marginal total).

```ad-tip
title: Assumptions
- Production ($P_{i}$) and attraction ($A_{j}$) for each zone is known by purpose

```

### Notation

Lower case letters indicate observations:
$$
\begin{align}
t_{ij}, o_{i}, d_{j} \\
\end{align}
$$
trips, trips originated, trips attracted

Uppe rcase letters represent values we are trying to model:
- $T_{ij}^{kn}:$ trips from $i$ to $j$ by mode $k$ and person type $n$ (population segment group)
- $O_{i},D_{j}:$ total number od trips originating at zone $i$ and attracted to zone $j$, respectively

If a subscript or superscript is omitted, we are impying a summation over that index:
$$
\begin{align}
T_{ij}^{n} &= \sum\limits_{k}T_{ij}^{kn} \\
T &= \sum\limits_{ij}T_{ij} \\
t &= \sum\limits_{ij}t_{ij}
\end{align}
$$


### Key principles

Here we list some key principle of trip distribution models:
- Bigger TAZs produce/attract more trips
- Closer TAZs attract more trips
- Further TAZs attract less trips: we will consider a **deterrence function** ($f(c_{ij})$ where $c_{ij}$ is the cost from TAZ $i$ to $j$).

## Trip distribution models

- **Demand origin-destination**
	- Beckmann & Golob: $t_{ij} = A_{i}B_{j}C_{ij}^{-\gamma} \Longrightarrow t_{ij} = A_{i}^{\alpha}B_{j}^{\beta}C_{ij}^{-\gamma}$
	- Wardrop: $t_{ij} = \dfrac{P_{i}P_{j}e^{-\theta D_{ij}}}{\sum\limits_{k}P_{k} e^{-\theta D_{ik}} }$
- **Choice**
	- Logit: $t_{ij}= G_{i} \dfrac{e^{-V_{ij}}}{\sum\limits_{k}e^{-V_{ik}}}$
- **Opportunity**
	- Of intervention...
	- Of competence...
- **[[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Gravity models\|#Gravity models]]**
- **[[#Entropy models]]**

### Gravity models

Gravity models are [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Trip distribution models\|#Trip distribution models]] inspired by [[Newton's law of gravitational attraction]]
the model for gravitational attraction between two masses.

```ad-Teo
title: Basic trip distribution gravity model

The basic gravity model is:
$
t_{ij} = k \frac{O_{i}D_{j}}{C_{ij}^{\theta}  }
$
where:
- $k:$ a constant
- $O_{i}:$ all trips generated from zone $i$ (= to marginal total $P_{i}$)
- $D_{j}:$ all trips attracted to zone $j$ (= to marginal total $A_{j}$)
- $C_{ij}:$ generalized cost from zone $i$ to zone $j$
- $\theta:$ another parameter (if $\theta=2$ then we have exactly the same form of Newton's law)

```

Variations of this model exist:
$$
\begin{cases}
t_{ij} = k O_{i}D_{j}e^{-\theta  C_{ij}} \\
t_{ij} = k O_{i}^{\alpha} D_{j}^{\beta} C_{ij}^{-\gamma} \qquad \text{Cobb-Douglas} \\
t_{ij} = k O_{i}^{\alpha} D_{j}^{\beta} e^{-\theta C_{ij}}
\end{cases}
$$
As we can see, these models have several parameters that need to be calibrated. At first, this might look like a difficult task:
$$
t_{ij} = k O_{i}^{\alpha}D_{j}^{\beta}C_{ij}^{\theta}
$$
But, if we apply a logarithmic transformation on both sides, we can simply the calibration process:
$$
\begin{align}
\log(t_{ij}) &= \log\left( k O_{i}^{\alpha}D_{j}^{\beta}C_{ij}^{\theta} \right) = \\
&= \log\left( k \right) + \alpha\log\left( O_{i} \right) + \beta \log\left( D_{j} \right) + \theta \log\left( C_{ij} \right)
\end{align}
$$
As we can see, this has now become a simple linear model in the form:
$$
Y_{ij} = \beta_{1} + \beta_{2}X_{2} + \beta_{3}X_{3} + \beta_{4}X_{4} 
$$
that can be easily estimated as a [[03 - Trip generation modeling - TDBM#Linear Regression Analysis|linear regression model]]. 

We considered $O_{i}, D_{j}, C_{ij}$ known and we have a sample for $t_{ij}$. so we can find estimates for $\hat{\alpha}, \hat{\beta}, \hat{\gamma}$.

As anticipated before, the issue with these kind of models is that the sum of the estimated $\hat{t}_{ij}$ along $i$ or $j$ does not always give the marginal totals. What we expect is:
$$
\begin{align}
O_{i} = \sum\limits_{j} \hat{t}_{ij} \\
D_{j} = \sum\limits_{i} \hat{t}_{ij}
\end{align}
$$
but this often does not happen. When this is the case singly or doubly constrained [[#Growth factors]] must be applied.

In order to predict future demand, growth factors are usually used

#### Growth factors

- [[#Uniform growth factor]]
- [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Singly constrained growth factor\|#Singly constrained growth factor]]
- [[#Doubly constrained growth factor]]

##### Uniform growth factor

The uniform growth factor is a simple way to predict future trips. Given data for a base year, we simply apply a growth of a certain percentage to every O/D pair.

The following table shows the base year trips:

![Schermata 2025-04-01 alle 15.34.46.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Schermata%202025-04-01%20alle%2015.34.46.png)

A growth factor of $20\%$ ($f$) is applied. We calculate the future trips $T_{ij}$ from the base trips $t_{ij}$ as:
$$
T_{ij} = f \cdot t_{ij}
$$
![Schermata 2025-04-01 alle 15.36.20.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-01%20alle%2015.36.20.png)

##### Singly constrained growth factor

The **Singly constrained** [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Growth factors\|growth factor]] is used when marginal totals of either production or attraction are not equal to the sum of the corresponding $t_{ij}$.

The following examples assumes that there is a difference in the origin totals ($O_{i}$).

The base OD matrix is shown:

![Schermata 2025-04-01 alle 15.40.15.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-01%20alle%2015.40.15.png)

Notice how $O_{i} = \sum\limits_{j}t_{ij}$ difference from the theoretical marginal total (the *target* in the table). For example, for TAZ 1, the ration between target and estimated origins is $a_{1}=1.13$. Notice also how the ratio is different for each TAZ.

Let $a_{i}$ be the ratio for origin $i$, then we apply the following transformation:
$$
T_{ij} = a_{i} \cdot t_{ij}
$$
and we get:

![Schermata 2025-04-01 alle 15.43.23.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-01%20alle%2015.43.23.png)

After the transformation we can see that $O_{i}$ is now always equal to the target.

```ad-note
title: Observation
Since the $T_{ij}$ are expectations, they do not need to be integer numbers.
```

##### Doubly constrained growth factor - Biproportional Fitting (BPF)

The **Doubly constrained** [[#Growth factors|growth factor]] is used when marginal totals of *both* production and attraction are not equal to the sum of the corresponding $t_{ij}$.

This method is also known under the name: **Bi-proportional fitting** (BPF).

We start from the following base O/D matrix:

![Schermata 2025-04-02 alle 16.57.24.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-02%20alle%2016.57.24.png)

In this case there is not a direct method to obtain a single growth factor. The same process described in [[#Singly constrained growth factor]] is applied several time alternatively for Origins and destinations until we get acceptable ratios between the marginal totals and the targets. 
- Calculate ratio for origins and apply it to every row
- Calculate ratio for attractions and apply it to every column
- Calculate ratio for origins and apply it to every row
- Calculate ratio for attractions and apply it to every column
- ... And so on
After not many iterations, we get a situation similar to that shown in the next table:

![Schermata 2025-04-02 alle 17.00.27.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-02%20alle%2017.00.27.png)

###### Limitations

Sparse matrices can cause problems when applying this method. If 0s are present, often the method will not converge. In this case, it is suggested to change these zeros to a low number of trips and try again. 

Be careful though. It's important to distinguish between *zeros by chance* (sampling error) and *structural zeros* (there are some trips that cannot physically be made).

### Synthetic distribution models

**Synthetic distribution models** are a kind of [[#Trip distribution models]] that generilize [[#Gravity models]] and try to bring more robust internal consistency. In their most general form:
$$
T_{ij} = A_{i}O_{i}B_{j}D_{j}f(C_{ij})
$$
where:
- $A_{i},B_{j}:$ balancing factors ensuring trip-end constraints are met (so to obtain internally consistent models)
- $f(C_{ij}):$ a functional for the travel cost between zone $i$ and zone $j$

Several functionals are proposed for the cost:
- $f(C_{ij}) = e^{-\beta C_{ij}}:$ exponential function
- $f(C_{ij}) = \alpha C_{ij}^{-\beta}:$ power function
- $f(C_{ij}) = \alpha C_{ij}^{-\beta} e^{-\gamma C_{ij}}:$ combined function (gamma)
- $f(C_{ij}) = \alpha e^{-\beta \ln^{2}(C_{ij}+1)}:$ lognormal function
- $f(C_{ij}) = \alpha e^{-\beta \ln^{2}\left(\frac{C_{ij}}{\gamma}\right)}:$ top lognormal function

Notice how each of these functionals has one or more parameters that need to be calibrated. This is one of the main problems in applying this model.

#### Apply a synthetic distribution models

In this section we will see how to use [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Synthetic distribution models\|#Synthetic distribution models]] to fill in the cells of an O/D matrix (calculate $T_{ij}$).

We will describe the process for a general functional $f(C_{ij})$ but keep in mind that the tables shown are using the functional $f(C_{ij}) = e^{-\beta C_{ij}}$ (for some value of $\beta$).

We start from a cost matrix. This matrix contains the cost $C_{ij}$ in the yellow cells. In the blue cells, the marginal totals $O_{i}$ and $D_{j}$ are shown.

![Schermata 2025-04-02 alle 17.32.56.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-02%20alle%2017.32.56.png)

Now we apply the functional to the whole matrix: take any cell and calculate $f(C_{ij})$. Whatch out, now the blue cells contain the sums of the yellow cells:

![Schermata 2025-04-02 alle 17.36.07.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-02%20alle%2017.36.07.png)

Now we need to apply the [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Doubly constrained growth factor - Biproportional Fitting (BPF)\|#Doubly constrained growth factor - Biproportional Fitting (BPF)]] method. To do so, we need a starting matrix containing trips. We can obtain it multiplying everything by an expansion factor calculated as:
$$
f = \frac{\sum\limits_{i} O_{i}}{\sum\limits_{i}f(C_{ij})} \equiv \frac{\sum\limits_{j} O_{j}}{\sum\limits_{j}f(C_{ij})}
$$
In this case, it would be:
$$
f = 343.44 = \frac{1962}{5.7128}
$$
Yielding:

![Schermata 2025-04-02 alle 17.39.29.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-02%20alle%2017.39.29.png)

from this, the BPF method is applied and we get the following matrix (now every cell contains a value that represents the number of trips):

![Schermata 2025-04-02 alle 17.40.32.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-02%20alle%2017.40.32.png)


### Entropy models

Entropy models are based on the law of [[entropy\|entropy]]:
$$
t_{ij} = A_{i}O_{i} B_{j}D_{j} e^{-k C_{ij}}
$$

❗❗❗❗❗❗❗❗❗❗❗❗
❗❗❗ COMPLETARE ❗❗❗
❗❗❗❗❗❗❗❗❗❗❗❗


#### Hyman's method

When we [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Apply a synthetic distribution models\|#Apply a synthetic distribution models]], we need to know the parameter of the cost functional $f(C_{ij})$. In the case of
$$
f(C_{ij}) = e^{-\beta C_{ij}}
$$

we can use **Hyman's method** to find the appropriate value of $\beta$.

To apply this method we need:
- $o_{i}:$ observed trip production
- $d_{j}:$ observed trip attraction
- $C_{ij}:$ cost matrix
- $MTL:$ Mean trip length
	- This is a parameter that is calculated from a smaller sample

Assumptions:
- $f(C_{ij}) = e^{-\beta C_{ij}}:$ $\beta$ unknown
- OD matrix can be obtained through [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Doubly constrained growth factor - Biproportional Fitting (BPF)\|#Doubly constrained growth factor - Biproportional Fitting (BPF)]]

As for other sections in this note, example numbers are shown in tables.

Let's assume we start from the following condition:

![Schermata 2025-04-02 alle 17.50.48.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Schermata%202025-04-02%20alle%2017.50.48.png)

We have marginal totals but no $t_{ij}$ and a cost matrix ($C_{ij}$). We also have a Mean Travel Cost $MTL = 10'$ (min).

We have to start with some value of $\beta$. We can set $\beta_{0}=1$. Then we calculate $\beta_{1}$ as:
$$
\beta_{1} = \frac{1}{MTL} = 0.1
$$
Now we have all the information needed to apply the [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Synthetic distribution models\|#Synthetic distribution models]]. We get the following matrix:

![Schermata 2025-04-02 alle 17.55.02.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-02%20alle%2017.55.02.png)

Let's now check the value of Mean Travel Time that we get from this: $MTL_{1}$. The Mean Travel Time is a weighted average of the travel costs using trips as weights. In this case:
$$
MTL_{1} = \frac{156*3 + 99*11 + \cdots + 58*12 + \cdots}{156+99+\cdots+58+\cdots} = 8.7
$$
The expected value of MTL is 10. They are too different, we need another iteration

Now we set $\beta_{2}$:
$$
\beta_{2} = \frac{MTL_{1}}{MTL} \beta_{1} = 0.087
$$
Calculate again the trip matrix as before and again $MTL_{2}$. If the difference with $MTL$ is still too big, then keep going. For following iterations, set $\beta$ as:
$$
\beta_{n} = \frac{(MTL-MTL_{n-2})\beta_{n-1} - (MTL-MTL_{n-1})\beta_{n-2}}{MTL_{n-1}-MTL_{n-2}}
$$
For the example used so far we get:
$$
\beta^{*} = 0.0586
$$

![Schermata 2025-04-02 alle 18.00.45.png](/img/user/Universit%C3%A0/Magistrale/1%C2%B0%20Anno/2%C2%B0%20Semestre/Travel%20Demand%20&%20Behavioural%20Modeling/Notes/Allegati/Allegati/Schermata%202025-04-02%20alle%2018.00.45.png)

Let $n$ be the iteration counter. The Hyman's method can be summarized in the following steps.
Let
$$
MTL_{n} = \sum\limits_{ij} \dfrac{T_{ij}^{(n}C_{ij}}{\sum\limits_{ij} T_{ij}^{(n}}
$$
$n=0$
- Set $\beta_{0} = 1$
- Do nothing

$n=1$
- Set $\beta_{1} = \dfrac{\beta_{1}}{MTL}$
- [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Apply a synthetic distribution models\|#Apply a synthetic distribution models]]
- If $MTL_{1} \ne MTL$ go to next iteration, otherwise stop

$n=2$
- Set $\beta_{2} =\beta_{1} \dfrac{MTL_{1}}{MTL}$
- [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Apply a synthetic distribution models\|#Apply a synthetic distribution models]]
- If $MTL_{2} \ne MTL$ go to next iteration, otherwise stop

$n>2$
- Set $\beta_{n} = \dfrac{(MTL-MTL_{n-2})\beta_{n-1} - (MTL-MTL_{n-1})\beta_{n-2}}{MTL_{n-1}-MTL_{n-2}}$
- [[Università/Magistrale/1° Anno/2° Semestre/Travel Demand & Behavioural Modeling/Notes/04 - Trip Distribution Modeling - TDBM#Apply a synthetic distribution models\|#Apply a synthetic distribution models]]
- If $MTL_{n} \ne MTL$ repeat, otherwise stop
